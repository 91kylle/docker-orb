description: >
 Install the Docker CLI. Supports versions `v18.06.1-ce-rc1` and newer,
 on all platforms/distros (Linux/Ubuntu/Debian, Linux/Alpine, macOS).
 Requirements: curl, grep, jq, tar

parameters:
  version:
    type: string
    default: latest
    description: >
      Version of Docker to install, defaults to the latest stable release.
      If specifying a version other than latest, provide a full release tag,
      as listed at https://api.github.com/repos/docker/cli/tags, e.g.,
      `v18.09.4`.

steps:
  - run:
      name: Install Docker CLI
      command: |
        if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi

        # grab Docker version
        if [[ <<parameters.version>> == "latest" ]]; then
          # extract latest version from GitHub releases API
          declare -i INDEX=0

          while :
          do
            INDEX_VERSION=$(curl https://api.github.com/repos/docker/cli/tags | \
              jq --argjson index "$INDEX" '.[$index].name')

            # filter out betas & release candidates
            if [[ $(echo "$INDEX_VERSION" | grep -v beta | grep -v rc) ]]; then

              # can't use substring expression < 0 on macOS
              DOCKER_VERSION="${INDEX_VERSION:1:$((${#INDEX_VERSION} - 1 - 1))}"

              echo "Latest stable version of Docker is $DOCKER_VERSION"
              break
            else
              INDEX=INDEX+1
            fi
          done
        else
          DOCKER_VERSION=<<parameters.version>>
          echo "Selected version of Docker is $DOCKER_VERSION"
        fi

        # check if Docker needs to be installed
        if command -v docker >> /dev/null 2>&1; then
          DOCKER_VERSION_NUMBER="${DOCKER_VERSION:1}"
          if docker --version | grep "$DOCKER_VERSION_NUMBER" >> /dev/null 2>&1; then
            echo "Docker $DOCKER_VERSION is already installed"
            exit 0
          else
            echo "A different version of Docker is installed: ($(docker --version)); removing it"
            $SUDO rm -f $(command -v docker)
          fi
        fi

        # get source download URL for specified version
        DOCKER_SOURCE_URL="https://codeload.github.com/docker/cli/legacy.tar.gz/$DOCKER_VERSION"

        # download tarball
        curl --output docker.tar.gz \
          --silent --show-error --location --fail --retry 3 \
          "$DOCKER_SOURCE_URL"

        tar xf docker.tar.gz && rm -rf docker.tar.gz

        # compile/install Docker
        cd docker-cli*

        # handle mac version
        if uname -a | grep Darwin; then
          make binary-osx
        else
          # linux version
          make binary
        fi
